<app-nav-bar></app-nav-bar>

<div class="home">
  <div class="left">
    <h1>Start Ride</h1>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="hint">
      Loading ride information...
    </div>

    <!-- Ride Completion Message -->
    <div *ngIf="rideCompletion" class="completion-card">
      <h2>Ride Completed!</h2>
      <div class="completion-info">
        <p><strong>Price:</strong> {{ rideCompletion.price | number:'1.2-2' }} RSD</p>
        <p><strong>Duration:</strong> {{ rideCompletion.durationMinutes }} minutes</p>
      </div>
      <button
        type="button"
        (click)="acknowledgeCompletion()"
        class="start-btn">
        OK
      </button>

    </div>

    <!-- No Active Ride -->
    <div *ngIf="!isLoading && !activeRide && !rideCompletion" class="hint">
      No ride assigned. Wait for a passenger to request a ride.
    </div>

    <!-- Active Ride Details -->
    <div *ngIf="!isLoading && activeRide && !rideCompletion">
      <div class="ride-info">
        <div class="info-row">
          <label>Ride ID:</label>
          <span>{{ activeRide.rideId }}</span>
        </div>

        <div class="info-row">
          <label>Status:</label>
          <span [ngClass]="{
            'status-ready': activeRide.status === 'DRIVER_READY',
            'status-incoming': activeRide.status === 'DRIVER_INCOMING',
            'status-arrived': activeRide.status === 'DRIVER_ARRIVED',
            'status-active': activeRide.status === 'ACTIVE',
            'status-default': activeRide.status !== 'DRIVER_READY' &&
                              activeRide.status !== 'DRIVER_INCOMING' &&
                              activeRide.status !== 'DRIVER_ARRIVED' &&
                              activeRide.status !== 'ACTIVE'
          }">
            {{ activeRide.status }}
          </span>
        </div>

        <div class="info-row">
          <label>Starting Point:</label>
          <span>{{ activeRide.startingPoint }}</span>
        </div>

        <div class="info-row">
          <label>Destination:</label>
          <span>{{ activeRide.endingPoint }}</span>
        </div>

        <div class="info-row">
          <label>Passenger:</label>
          <span>{{ activeRide.passengerName }}</span>
        </div>

        <div class="info-row">
          <label>Total Passengers:</label>
          <span>{{ activeRide.passengerCount }}</span>
        </div>

        <div class="info-row">
          <label>Estimated Time:</label>
          <span>{{ activeRide.estimatedTimeMin || 0 }} min</span>
        </div>

        <div class="info-row">
          <label>Estimated Price:</label>
          <span>{{ activeRide.estimatedPrice | number:'1.2-2' }} RSD</span>
        </div>
      </div>

      <!-- Status Messages -->
      <div *ngIf="activeRide.status === 'DRIVER_READY'" class="hint">
        New ride assigned! Review details and accept when ready.
      </div>

      <div *ngIf="activeRide.status === 'DRIVER_INCOMING'" class="hint">
        Driving to pickup location...
      </div>

      <div *ngIf="activeRide.status === 'DRIVER_ARRIVED'" class="hint">
        Arrived at pickup! Waiting for passengers to enter...
      </div>

      <div *ngIf="activeRide.status === 'ACTIVE'" class="hint">
        Ride in progress!
      </div>

      <div *ngIf="activeRide.status === 'DRIVER_ARRIVED_AT_DESTINATION'" class="hint">
        Arrived at destination! Ready to end the ride.
      </div>

      <div *ngIf="activeRide.status === 'FINISHED'" class="hint">
        Ride completed!
      </div>


      <!-- Action Buttons -->
      <div class="form-actions">
        <!-- Accept Ride Button (DRIVER_READY) -->
        <button
          *ngIf="activeRide.status === 'DRIVER_READY'"
          type="button"
          (click)="acceptRide()"
          [disabled]="isAccepting"
          class="start-btn">
          {{ isAccepting ? 'Accepting...' : 'Accept Ride' }}
        </button>

        <!-- Start Ride Button (DRIVER_ARRIVED) -->
        <button
          *ngIf="activeRide.status === 'DRIVER_ARRIVED'"
          type="button"
          (click)="startRide()"
          [disabled]="isStarting"
          class="start-btn">
          {{ isStarting ? 'Starting...' : 'Start Ride' }}
        </button>

        <button
          *ngIf="activeRide.status === 'DRIVER_ARRIVED_AT_DESTINATION'"
          type="button"
          (click)="finishRide()"
          [disabled]="isEnding"
          class="end-btn">
          {{ isEnding ? 'Ending...' : 'End Ride' }}
        </button>


        <!-- Stop Ride Button (ACTIVE) -->
        <button
          *ngIf="activeRide.status === 'ACTIVE'"
          type="button"
          (click)="stopRide()"
          [disabled]="isStopping"
          class="stop-btn">
          {{ isStopping ? 'Stopping...' : 'Stop Ride' }}
        </button>

        <!-- Cancel Ride Button (after accept, before start) -->
        <button
          *ngIf="canShowCancelButton()"
          type="button"
          (click)="openCancelForm()"
          [disabled]="isCancelling"
          class="stop-btn">
          {{ isCancelling ? 'Cancelling...' : 'Cancel Ride' }}
        </button>
      </div>

      <!-- Cancel Ride Reason Form -->
      <div *ngIf="showCancelForm" class="cancel-overlay">
        <div class="cancel-dialog">
          <h3>Cancel Ride</h3>
          <p>Please provide a reason for cancelling this ride:</p>
          <textarea
            [(ngModel)]="cancelReason"
            rows="3"
            placeholder="E.g. Passenger not at pickup location, health issue, etc.">
          </textarea>
          <div class="cancel-actions">
            <button
              type="button"
              class="start-btn"
              (click)="confirmCancelRide()"
              [disabled]="isCancelling">
              {{ isCancelling ? 'Cancelling...' : 'Confirm Cancel' }}
            </button>
            <button
              type="button"
              class="stop-btn"
              (click)="closeCancelForm()"
              [disabled]="isCancelling">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Messages -->
    <div *ngIf="errorMessage" class="error">{{ errorMessage }}</div>
    <div *ngIf="successMessage" class="success">{{ successMessage }}</div>
  </div>

  <div class="right">
    <app-ride-tracking-map (estimatedTimeChange)="onEstimatedTimeChange($event)"></app-ride-tracking-map>
  </div>
</div>
